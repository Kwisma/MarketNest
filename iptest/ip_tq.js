import fs from "fs";
import path from "path";
import url from "url";
import fetch from "node-fetch";
import { JSDOM } from "jsdom";
//æ¯ä¸ªå›½å®¶æå‰æ•°é‡
const shu = 5;
// æ˜¯å¦è¿‡æ»¤ä¸‹è½½é€Ÿåº¦
const speed = true;
// è¿‡æ»¤ä¸‹è½½é€Ÿåº¦ä¸‹é™ï¼Œå•ä½kb/s
const test = 0;
// è·å–å½“å‰è„šæœ¬è·¯å¾„
const __filename = url.fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// æå–åˆ—
const ip = "IPåœ°å€";
const port = "ç«¯å£";
const speedtestresult = "ä¸‹è½½é€Ÿåº¦";
const datacenter = "æ•°æ®ä¸­å¿ƒ";

const extractedData = {
  AF: "ğŸ‡¦ğŸ‡«é˜¿å¯Œæ±—",
  AL: "ğŸ‡¦ğŸ‡±é˜¿å°”å·´å°¼äºš",
  DZ: "ğŸ‡©ğŸ‡¿é˜¿å°”åŠåˆ©äºš",
  AS: "ğŸ‡¦ğŸ‡¸ç¾å±è¨æ‘©äºš",
  AD: "ğŸ‡¦ğŸ‡©å®‰é“å°”",
  AO: "ğŸ‡¦ğŸ‡´å®‰å“¥æ‹‰",
  AI: "ğŸ‡¦ğŸ‡®å®‰åœ­æ‹‰",
  AQ: "ğŸ‡¦ğŸ‡¶Antarctica",
  AG: "ğŸ‡¦ğŸ‡¬å®‰æç“œå’Œå·´å¸ƒè¾¾",
  AR: "ğŸ‡¦ğŸ‡·é˜¿æ ¹å»·",
  AM: "ğŸ‡¦ğŸ‡²äºšç¾å°¼äºš",
  AW: "ğŸ‡¦ğŸ‡¼é˜¿é²å·´",
  AU: "ğŸ‡¦ğŸ‡ºæ¾³å¤§åˆ©äºš",
  AT: "ğŸ‡¦ğŸ‡¹å¥¥åœ°åˆ©",
  AZ: "ğŸ‡¦ğŸ‡¿é˜¿å¡æ‹œç–†",
  BS: "ğŸ‡§ğŸ‡¸å·´å“ˆé©¬",
  BH: "ğŸ‡§ğŸ‡­å·´æ—",
  BD: "ğŸ‡§ğŸ‡©å­ŸåŠ æ‹‰å›½",
  BB: "ğŸ‡§ğŸ‡§å·´å·´å¤šæ–¯",
  BY: "ğŸ‡§ğŸ‡¾ç™½ä¿„ç½—æ–¯",
  BE: "ğŸ‡§ğŸ‡ªæ¯”åˆ©æ—¶",
  BZ: "ğŸ‡§ğŸ‡¿ä¼¯åˆ©å…¹",
  BJ: "ğŸ‡§ğŸ‡¯è´å®",
  BM: "ğŸ‡§ğŸ‡²ç™¾æ…•å¤§",
  BT: "ğŸ‡§ğŸ‡¹ä¸ä¸¹",
  BO: "ğŸ‡§ğŸ‡´ç»åˆ©ç»´äºšå¤šæ°‘æ—å›½",
  BA: "ğŸ‡§ğŸ‡¦æ³¢æ–¯å°¼äºšå’Œé»‘å¡å“¥ç»´é‚£",
  BW: "ğŸ‡§ğŸ‡¼åšèŒ¨ç“¦çº³",
  BV: "ğŸ‡§ğŸ‡»å¸ƒç»´å²›",
  BR: "ğŸ‡§ğŸ‡·å·´è¥¿",
  IO: "ğŸ‡®ğŸ‡´è‹±å±å°åº¦æ´‹é¢†åœ°",
  VG: "ğŸ‡»ğŸ‡¬ç»´å°”äº¬ç¾¤å²›ï¼Œè‹±å±",
  BN: "ğŸ‡§ğŸ‡³æ–‡è±",
  BG: "ğŸ‡§ğŸ‡¬ä¿åŠ åˆ©äºš",
  BF: "ğŸ‡§ğŸ‡«å¸ƒåŸºçº³æ³•ç´¢",
  MM: "ğŸ‡²ğŸ‡²ç¼…ç”¸",
  BI: "ğŸ‡§ğŸ‡®å¸ƒéš†è¿ª",
  CV: "ğŸ‡¨ğŸ‡»ä½›å¾—è§’",
  KH: "ğŸ‡°ğŸ‡­æŸ¬åŸ”å¯¨",
  CM: "ğŸ‡¨ğŸ‡²å–€éº¦éš†",
  CA: "ğŸ‡¨ğŸ‡¦åŠ æ‹¿å¤§",
  KY: "ğŸ‡°ğŸ‡¾å¼€æ›¼ç¾¤å²›",
  CF: "ğŸ‡¨ğŸ‡«ä¸­éå…±å’Œå›½",
  TD: "ğŸ‡¹ğŸ‡©æŸ¥å¾·",
  CL: "ğŸ‡¨ğŸ‡±æ™ºåˆ©",
  CN: "ğŸ‡¨ğŸ‡³ä¸­å›½",
  CX: "ğŸ‡¨ğŸ‡½åœ£è¯å²›",
  CC: "ğŸ‡¨ğŸ‡¨ç§‘ç§‘æ–¯",
  CO: "ğŸ‡¨ğŸ‡´å“¥ä¼¦æ¯”äºš",
  KM: "ğŸ‡°ğŸ‡²ç§‘æ‘©ç½—",
  CD: "ğŸ‡¨ğŸ‡©åˆšæœæ°‘ä¸»å…±å’Œå›½",
  CG: "ğŸ‡¨ğŸ‡¬åˆšæœ",
  CK: "ğŸ‡¨ğŸ‡°åº“å…‹ç¾¤å²›",
  CR: "ğŸ‡¨ğŸ‡·å“¥æ–¯è¾¾é»åŠ ",
  CI: "ğŸ‡¨ğŸ‡®ç§‘ç‰¹è¿ªç“¦",
  HR: "ğŸ‡­ğŸ‡·å…‹ç½—åœ°äºš",
  CU: "ğŸ‡¨ğŸ‡ºå¤å·´",
  CW: "ğŸ‡¨ğŸ‡¼åº“æ‹‰ç´¢",
  CY: "ğŸ‡¨ğŸ‡¾å¡æµ¦è·¯æ–¯",
  CZ: "ğŸ‡¨ğŸ‡¿æ·å…‹å…±å’Œå›½",
  DK: "ğŸ‡©ğŸ‡°ä¸¹éº¦",
  DJ: "ğŸ‡©ğŸ‡¯å‰å¸ƒæ",
  DM: "ğŸ‡©ğŸ‡²å¤šç±³å°¼å…‹",
  DO: "ğŸ‡©ğŸ‡´å¤šæ˜å°¼åŠ å…±å’Œå›½",
  EC: "ğŸ‡ªğŸ‡¨å„ç“œå¤šå°”",
  EG: "ğŸ‡ªğŸ‡¬åŸƒåŠ",
  SV: "ğŸ‡¸ğŸ‡»è¨å°”ç“¦å¤š",
  GQ: "ğŸ‡¬ğŸ‡¶èµ¤é“å‡ å†…äºš",
  ER: "ğŸ‡ªğŸ‡·å„ç«‹ç‰¹é‡Œäºš",
  EE: "ğŸ‡ªğŸ‡ªçˆ±æ²™å°¼äºš",
  ET: "ğŸ‡ªğŸ‡¹åŸƒå¡ä¿„æ¯”äºš",
  FK: "ğŸ‡«ğŸ‡°ç¦å…‹å…°ç¾¤å²›ï¼ˆé©¬å°”ç»´çº³æ–¯ç¾¤å²›ï¼‰",
  FO: "ğŸ‡«ğŸ‡´æ³•ç½—ç¾¤å²›",
  FJ: "ğŸ‡«ğŸ‡¯æ–",
  FI: "ğŸ‡«ğŸ‡®èŠ¬å…°",
  FR: "ğŸ‡«ğŸ‡·æ³•å›½",
  FX: "ğŸ‡«ğŸ‡½æ³•å›½æœ¬åœŸ",
  GF: "ğŸ‡¬ğŸ‡«æ³•å±åœ­äºšé‚£",
  PF: "ğŸ‡µğŸ‡«æ³•å±æ³¢åˆ©å°¼è¥¿äºš",
  TF: "ğŸ‡¹ğŸ‡«æ³•å›½å—æ–¹çš„é¢†åœŸ",
  GA: "ğŸ‡¬ğŸ‡¦åŠ è“¬",
  GM: "ğŸ‡¬ğŸ‡²å†ˆæ¯”äºš",
  PS: "ğŸ‡µğŸ‡¸å·´å‹’æ–¯å¦ï¼Œå›½å®¶",
  GE: "ğŸ‡¬ğŸ‡ªæ ¼é²å‰äºš",
  DE: "ğŸ‡©ğŸ‡ªå¾·å›½",
  GH: "ğŸ‡¬ğŸ‡­åŠ çº³",
  GI: "ğŸ‡¬ğŸ‡®ç›´å¸ƒç½—é™€",
  GR: "ğŸ‡¬ğŸ‡·å¸Œè…Š",
  GL: "ğŸ‡¬ğŸ‡±æ ¼é™µå…°",
  GD: "ğŸ‡¬ğŸ‡©æ ¼æ—çº³è¾¾",
  GP: "ğŸ‡¬ğŸ‡µç“œå¾·ç½—æ™®å²›",
  GU: "ğŸ‡¬ğŸ‡ºå…³å²›",
  GT: "ğŸ‡¬ğŸ‡¹å±åœ°é©¬æ‹‰",
  GG: "ğŸ‡¬ğŸ‡¬æ ¹è¥¿å²›",
  GN: "ğŸ‡¬ğŸ‡³å‡ å†…äºš",
  GW: "ğŸ‡¬ğŸ‡¼å‡ å†…äºšæ¯”ç»",
  GY: "ğŸ‡¬ğŸ‡¾åœ­äºšé‚£",
  HT: "ğŸ‡­ğŸ‡¹æµ·åœ°",
  HM: "ğŸ‡­ğŸ‡²èµ«å¾·å²›å’Œéº¦å…‹å”çº³ç¾¤å²›",
  VA: "ğŸ‡»ğŸ‡¦æ•™å»·ï¼ˆæ¢µè’‚å†ˆåŸå›½ï¼‰",
  HN: "ğŸ‡­ğŸ‡³æ´ªéƒ½æ‹‰æ–¯",
  HK: "ğŸ‡­ğŸ‡°é¦™æ¸¯",
  HU: "ğŸ‡­ğŸ‡ºåŒˆç‰™åˆ©",
  IS: "ğŸ‡®ğŸ‡¸å†°å²›",
  IN: "ğŸ‡®ğŸ‡³å°åº¦",
  ID: "ğŸ‡®ğŸ‡©å°åº¦å°¼è¥¿äºš",
  IR: "ğŸ‡®ğŸ‡·ä¼Šæœ—",
  IQ: "ğŸ‡®ğŸ‡¶ä¼Šæ‹‰å…‹",
  IE: "ğŸ‡®ğŸ‡ªçˆ±å°”å…°",
  IM: "ğŸ‡®ğŸ‡²é©¬æ©å²›",
  IL: "ğŸ‡®ğŸ‡±ä»¥è‰²åˆ—",
  IT: "ğŸ‡®ğŸ‡¹æ„å¤§åˆ©",
  JM: "ğŸ‡¯ğŸ‡²ç‰™ä¹°åŠ ",
  JP: "ğŸ‡¯ğŸ‡µæ—¥æœ¬",
  JE: "ğŸ‡¯ğŸ‡ªæ–°æ³½è¥¿",
  JO: "ğŸ‡¯ğŸ‡´çº¦æ—¦",
  KZ: "ğŸ‡°ğŸ‡¿å“ˆè¨å…‹æ–¯å¦",
  KE: "ğŸ‡°ğŸ‡ªè‚¯å°¼äºš",
  KI: "ğŸ‡°ğŸ‡®åŸºé‡Œå·´æ–¯",
  KP: "ğŸ‡°ğŸ‡µæœé²œ",
  KR: "ğŸ‡°ğŸ‡·éŸ©å›½",
  XK: "ğŸ‡½ğŸ‡°ç§‘ç´¢æ²ƒ",
  KW: "ğŸ‡°ğŸ‡¼ç§‘å¨ç‰¹",
  KG: "ğŸ‡°ğŸ‡¬å‰å°”å‰æ–¯æ–¯å¦",
  LA: "ğŸ‡±ğŸ‡¦è€æŒäººæ°‘æ°‘ä¸»å…±å’Œå›½",
  LV: "ğŸ‡±ğŸ‡»æ‹‰è„±ç»´äºš",
  LB: "ğŸ‡±ğŸ‡§é»å·´å«©",
  LS: "ğŸ‡±ğŸ‡¸è±ç´¢æ‰˜",
  LR: "ğŸ‡±ğŸ‡·åˆ©æ¯”é‡Œäºš",
  LY: "ğŸ‡±ğŸ‡¾åˆ©æ¯”äºš",
  LI: "ğŸ‡±ğŸ‡®åˆ—æ”¯æ•¦å£«ç™»",
  LT: "ğŸ‡±ğŸ‡¹ç«‹é™¶å®›",
  LU: "ğŸ‡±ğŸ‡ºå¢æ£®å ¡",
  MO: "ğŸ‡²ğŸ‡´æ¾³é—¨",
  MK: "ğŸ‡²ğŸ‡°åŒ—é©¬å…¶é¡¿",
  MG: "ğŸ‡²ğŸ‡¬é©¬è¾¾åŠ æ–¯åŠ ",
  MW: "ğŸ‡²ğŸ‡¼é©¬æ‹‰ç»´",
  MY: "ğŸ‡²ğŸ‡¾é©¬æ¥è¥¿äºš",
  MV: "ğŸ‡²ğŸ‡»é©¬å°”ä»£å¤«",
  ML: "ğŸ‡²ğŸ‡±é©¬é‡Œ",
  MT: "ğŸ‡²ğŸ‡¹é©¬è€³ä»–",
  MH: "ğŸ‡²ğŸ‡­é©¬ç»å°”ç¾¤å²›",
  MQ: "ğŸ‡²ğŸ‡¶é©¬æå°¼å…‹",
  MR: "ğŸ‡²ğŸ‡·æ¯›é‡Œå¡”å°¼äºš",
  MU: "ğŸ‡²ğŸ‡ºæ¯›é‡Œæ±‚æ–¯",
  YT: "ğŸ‡¾ğŸ‡¹é©¬çº¦ç‰¹",
  MX: "ğŸ‡²ğŸ‡½å¢¨è¥¿å“¥",
  FM: "ğŸ‡«ğŸ‡²å¯†å…‹ç½—å°¼è¥¿äºšï¼ˆè”é‚¦ï¼‰",
  MD: "ğŸ‡²ğŸ‡©æ‘©å°”å¤šç“¦å…±å’Œå›½",
  MC: "ğŸ‡²ğŸ‡¨æ‘©çº³å“¥",
  MN: "ğŸ‡²ğŸ‡³è’™å¤",
  ME: "ğŸ‡²ğŸ‡ªé»‘å±±",
  MS: "ğŸ‡²ğŸ‡¸è’™ç‰¹å¡æ‹‰ç‰¹",
  MA: "ğŸ‡²ğŸ‡¦æ‘©æ´›å“¥",
  MZ: "ğŸ‡²ğŸ‡¿è«æ¡‘æ¯”å…‹",
  NA: "ğŸ‡³ğŸ‡¦çº³ç±³æ¯”äºš",
  NR: "ğŸ‡³ğŸ‡·ç‘™é²",
  NP: "ğŸ‡³ğŸ‡µå°¼æ³Šå°”",
  NL: "ğŸ‡³ğŸ‡±è·å…°",
  AN: "ğŸ‡¦ğŸ‡³è·å±å®‰çš„åˆ—æ–¯",
  NC: "ğŸ‡³ğŸ‡¨æ–°å–€é‡Œå¤šå°¼äºš",
  NZ: "ğŸ‡³ğŸ‡¿æ–°è¥¿å…°",
  NI: "ğŸ‡³ğŸ‡®å°¼åŠ æ‹‰ç“œ",
  NE: "ğŸ‡³ğŸ‡ªå°¼æ—¥å°”",
  NG: "ğŸ‡³ğŸ‡¬å°¼æ—¥åˆ©äºš",
  NU: "ğŸ‡³ğŸ‡ºçº½åŸƒ",
  NF: "ğŸ‡³ğŸ‡«è¯ºç¦å…‹å²›",
  MP: "ğŸ‡²ğŸ‡µåŒ—é©¬é‡Œäºšçº³ç¾¤å²›",
  NO: "ğŸ‡³ğŸ‡´æŒªå¨",
  OM: "ğŸ‡´ğŸ‡²é˜¿æ›¼",
  PK: "ğŸ‡µğŸ‡°å·´åŸºæ–¯å¦",
  PW: "ğŸ‡µğŸ‡¼å¸•åŠ³",
  PA: "ğŸ‡µğŸ‡¦å·´æ‹¿é©¬",
  PG: "ğŸ‡µğŸ‡¬å·´å¸ƒäºšæ–°å‡ å†…äºš",
  PY: "ğŸ‡µğŸ‡¾å·´æ‹‰åœ­",
  PE: "ğŸ‡µğŸ‡ªç§˜é²",
  PH: "ğŸ‡µğŸ‡­è²å¾‹å®¾",
  PN: "ğŸ‡µğŸ‡³çš®ç‰¹å‡¯æ©",
  PL: "ğŸ‡µğŸ‡±æ³¢å…°",
  PT: "ğŸ‡µğŸ‡¹è‘¡è„ç‰™",
  PR: "ğŸ‡µğŸ‡·æ³¢å¤šé»å„",
  QA: "ğŸ‡¶ğŸ‡¦å¡å¡”å°”",
  RE: "ğŸ‡·ğŸ‡ªå›¢åœ†",
  RO: "ğŸ‡·ğŸ‡´ç½—é©¬å°¼äºš",
  TW: "ğŸ‡¹ğŸ‡¼å°æ¹¾",
  RU: "ğŸ‡·ğŸ‡ºä¿„ç½—æ–¯è”é‚¦",
  RW: "ğŸ‡·ğŸ‡¼å¢æ—ºè¾¾",
  BL: "ğŸ‡§ğŸ‡±åœ£å·´æ³°å‹’ç±³",
  SH: "ğŸ‡¸ğŸ‡­åœ£èµ«å‹’æ‹¿å²›ï¼Œé˜¿æ£®æ¾å²›å’Œç‰¹é‡Œæ–¯å¦ - è¾¾åº“å°¼äºšç¾¤å²›",
  KN: "ğŸ‡°ğŸ‡³åœ£åŸºèŒ¨å’Œå°¼ç»´æ–¯",
  LC: "ğŸ‡±ğŸ‡¨åœ£å¢è¥¿äºš",
  MF: "ğŸ‡²ğŸ‡«åœ£é©¬ä¸å²›ï¼ˆæ³•å±ï¼‰",
  VC: "ğŸ‡»ğŸ‡¨åœ£æ–‡æ£®ç‰¹å’Œæ ¼æ—çº³ä¸æ–¯",
  WS: "ğŸ‡¼ğŸ‡¸è¨æ‘©äºš",
  SM: "ğŸ‡¸ğŸ‡²åœ£é©¬åŠ›è¯º",
  ST: "ğŸ‡¸ğŸ‡¹åœ£å¤šç¾å’Œæ™®æ—è¥¿æ¯”",
  SA: "ğŸ‡¸ğŸ‡¦æ²™ç‰¹é˜¿æ‹‰ä¼¯",
  SN: "ğŸ‡¸ğŸ‡³å¡å†…åŠ å°”",
  RS: "ğŸ‡·ğŸ‡¸å¡å°”ç»´äºš",
  SC: "ğŸ‡¸ğŸ‡¨å¡èˆŒå°”",
  SL: "ğŸ‡¸ğŸ‡±å¡æ‹‰åˆ©æ˜‚",
  SG: "ğŸ‡¸ğŸ‡¬æ–°åŠ å¡",
  SX: "ğŸ‡¸ğŸ‡½åœ£é©¬ä¸å²›ï¼ˆè·å…°çš„ä¸€éƒ¨åˆ†ï¼‰",
  SK: "ğŸ‡¸ğŸ‡°æ–¯æ´›ä¼å…‹",
  SI: "ğŸ‡¸ğŸ‡®æ–¯æ´›æ–‡å°¼äºš",
  SB: "ğŸ‡¸ğŸ‡§æ‰€ç½—é—¨ç¾¤å²›",
  SO: "ğŸ‡¸ğŸ‡´ç´¢é©¬é‡Œ",
  ZA: "ğŸ‡¿ğŸ‡¦å—é",
  GS: "ğŸ‡¬ğŸ‡¸å—ä¹”æ²»äºšå²›å’Œå—æ¡‘å¨å¥‡ç¾¤å²›",
  SS: "ğŸ‡¸ğŸ‡¸å—è‹ä¸¹",
  ES: "ğŸ‡ªğŸ‡¸è¥¿ç­ç‰™",
  LK: "ğŸ‡±ğŸ‡°æ–¯é‡Œå…°å¡",
  SD: "ğŸ‡¸ğŸ‡©è‹ä¸¹",
  SR: "ğŸ‡¸ğŸ‡·è‹é‡Œå—",
  PM: "ğŸ‡µğŸ‡²åœ£çš®åŸƒå°”å’Œå¯†å…‹éš†",
  SZ: "ğŸ‡¸ğŸ‡¿æ–¯å¨å£«å…°",
  SE: "ğŸ‡¸ğŸ‡ªç‘å…¸",
  CH: "ğŸ‡¨ğŸ‡­ç‘å£«",
  SY: "ğŸ‡¸ğŸ‡¾å™åˆ©äºš",
  TJ: "ğŸ‡¹ğŸ‡¯å¡”å‰å…‹æ–¯å¦",
  TZ: "ğŸ‡¹ğŸ‡¿å¦æ¡‘å°¼äºšè”åˆå…±å’Œå›½",
  TH: "ğŸ‡¹ğŸ‡­æ³°å›½",
  TL: "ğŸ‡¹ğŸ‡±ä¸œå¸æ±¶",
  TG: "ğŸ‡¹ğŸ‡¬å¤šå“¥",
  TK: "ğŸ‡¹ğŸ‡°æ‰˜å…‹åŠ³",
  TO: "ğŸ‡¹ğŸ‡´æ±¤åŠ ",
  TT: "ğŸ‡¹ğŸ‡¹ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥",
  TN: "ğŸ‡¹ğŸ‡³çªå°¼æ–¯",
  TR: "ğŸ‡¹ğŸ‡·åœŸè€³å…¶",
  TM: "ğŸ‡¹ğŸ‡²åœŸåº“æ›¼æ–¯å¦",
  TC: "ğŸ‡¹ğŸ‡¨ç‰¹å…‹æ–¯å’Œå‡¯ç§‘æ–¯ç¾¤å²›",
  TV: "ğŸ‡¹ğŸ‡»å›¾ç“¦å¢",
  UG: "ğŸ‡ºğŸ‡¬ä¹Œå¹²è¾¾",
  UA: "ğŸ‡ºğŸ‡¦ä¹Œå…‹å…°",
  AE: "ğŸ‡¦ğŸ‡ªé˜¿æ‹‰ä¼¯è”åˆé…‹é•¿å›½",
  GB: "ğŸ‡¬ğŸ‡§è‹±å›½",
  US: "ğŸ‡ºğŸ‡¸ç¾å›½",
  UM: "ğŸ‡ºğŸ‡²ç¾å›½æœ¬åœŸå¤–å°å²›å±¿",
  UY: "ğŸ‡ºğŸ‡¾ä¹Œæ‹‰åœ­",
  UZ: "ğŸ‡ºğŸ‡¿ä¹Œå…¹åˆ«å…‹æ–¯å¦",
  VU: "ğŸ‡»ğŸ‡ºç“¦åŠªé˜¿å›¾",
  VE: "ğŸ‡»ğŸ‡ªå§”å†…ç‘æ‹‰",
  VN: "ğŸ‡»ğŸ‡³è¶Šå—",
  VI: "ğŸ‡»ğŸ‡®ç»´å°”äº¬ç¾¤å²›ï¼Œç¾å›½",
  WF: "ğŸ‡¼ğŸ‡«ç“¦åˆ©æ–¯å’Œå¯Œå›¾çº³ç¾¤å²›",
  EH: "ğŸ‡ªğŸ‡­è¥¿æ’’å“ˆæ‹‰",
  UN: "ğŸ‡ºğŸ‡³è”åˆå›½",
  EU: "ğŸ‡ªğŸ‡ºæ¬§ç›Ÿ",
  YE: "ğŸ‡¾ğŸ‡ªä¹Ÿé—¨",
  ZM: "ğŸ‡¿ğŸ‡²èµæ¯”äºš",
  ZW: "ğŸ‡¿ğŸ‡¼æ´¥å·´å¸ƒéŸ¦",
  WI: "ğŸ‡¼ğŸ‡®è¥¿å°åº¦ç¾¤å²›è”é‚¦",
  EN: "ğŸ‡ªğŸ‡³ç‹¬ç«‹å›½å®¶è”åˆä½“",
  YG: "ğŸ‡¾ğŸ‡¬å—æ–¯æ‹‰å¤«",
  UR: "ğŸ‡ºğŸ‡·è‹è”",
  DH: "ğŸ‡©ğŸ‡­è¾¾è·ç¾",
  VL: "ğŸ‡»ğŸ‡±ä¸Šæ²ƒå°”ç‰¹",
  AX: "ğŸ‡¦ğŸ‡½å¥¥å…°ç¾¤å²›",
  BQ: "ğŸ‡§ğŸ‡¶åšå†…å°”å²›ï¼Œåœ£å°¤æ–¯ç‰¹æ­‡æ–¯å’Œè¨å·´",
  SJ: "ğŸ‡¸ğŸ‡¯æ–¯ç“¦å°”å·´ç‰¹",
};
async function processCSVFiles() {
  try {
    // è·å–æ‰€æœ‰ CSV æ–‡ä»¶
    const files = fs
      .readdirSync(__dirname)
      .filter((file) => file.endsWith(".csv"));
    if (files.length === 0) {
      console.log("æœªæ‰¾åˆ° CSV æ–‡ä»¶ã€‚");
      return;
    }

    console.log(`å‘ç° ${files.length} ä¸ª CSV æ–‡ä»¶ï¼Œå¼€å§‹å¤„ç†...`);

    for (const file of files) {
      const csvFilePath = path.resolve(__dirname, file);
      const txtFilePath = path.resolve(__dirname, file.replace(".csv", ".txt"));

      console.log(`å¤„ç†æ–‡ä»¶: ${file}`);
      await extractIpAndPort(csvFilePath, txtFilePath);
    }
  } catch (error) {
    console.error("å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:", error.message);
  }
}
async function extractIpAndPort(csvFilePath, txtFilePath) {
  try {
    // è¯»å– CSV æ–‡ä»¶å†…å®¹
    console.log(`å¼€å§‹è¯»å– CSV æ–‡ä»¶...${csvFilePath}`);
    const data = await fs.promises.readFile(csvFilePath, "utf8");
    console.log("CSV æ–‡ä»¶è¯»å–æˆåŠŸã€‚");

    // æŒ‰è¡Œåˆ†å‰² CSV å†…å®¹
    const lines = data
      .split("\n")
      .map((line) => line.trim())
      .filter((line) => line); // å»æ‰ç©ºè¡Œ
    if (lines.length < 2) {
      throw new Error("CSV æ–‡ä»¶å†…å®¹ä¸è¶³æˆ–æ ¼å¼ä¸æ­£ç¡®");
    }
    console.log("CSV æ–‡ä»¶å†…å®¹å¤„ç†å®Œæˆã€‚");

    // è·å–è¡¨å¤´
    const headers = lines[0].split(",");
    const ipIndex = headers.indexOf(ip);
    const portIndex = headers.indexOf(port);
    const speedIndex = headers.indexOf(speedtestresult);
    const datacenterIndex = headers.indexOf(datacenter);

    if (ipIndex === -1 || portIndex === -1 || datacenterIndex === -1) {
      throw new Error(`CSV æ–‡ä»¶ç¼ºå°‘ ${ip}ã€${port} æˆ– ${datacenter} åˆ—`);
    }
    console.log("CSV æ–‡ä»¶åˆ—ç´¢å¼•æ£€æŸ¥é€šè¿‡ã€‚");

    // æ•°æ®ä¸­å¿ƒä»£ç ä¸å›½å®¶çš„æ˜ å°„
    console.log("å¼€å§‹è·å–æ•°æ®ä¸­å¿ƒä¸å›½å®¶çš„æ˜ å°„...");
    const dataMap = await getDatacenterMap();
    console.log("æ•°æ®ä¸­å¿ƒä¸å›½å®¶çš„æ˜ å°„è·å–æˆåŠŸã€‚");

    // æå– IP å’Œç«¯å£
    console.log("å¼€å§‹æå– IP å’Œç«¯å£...");

    const ipEntries = lines
      .slice(1) // å»æ‰è¡¨å¤´
      .map((line) => line.split(",")) // æŒ‰é€—å·åˆ†å‰²æ¯ä¸€è¡Œ
      .filter(
        (fields) =>
          fields.length >
          Math.max(ipIndex, portIndex, speedIndex, datacenterIndex),
      ) // ç¡®ä¿æœ‰è¶³å¤Ÿçš„åˆ—
      .filter((fields) => {
        if (speed) {
          const speedField = fields[speedIndex];
          if (speedField) {
            const speedfo = parseFloat(fields[speedIndex].replace(" kB/s", ""));
            return speedfo > test;
          }
        }
        return true;
      })
      .map((fields) => {
        const ip = fields[ipIndex];
        const port = fields[portIndex];
        const dc = fields[datacenterIndex];
        const country =
          Object.keys(dataMap).find((country) =>
            dataMap[country].includes(dc),
          ) || "å…¶ä»–";
        console.log(`æå–ï¼š${ip}:${port}#${country}`);
        return { entry: `${ip}:${port}#${country}`, country };
      });

    console.log(`IP å’Œç«¯å£æå–å®Œæˆã€‚${ipEntries.length}`);

    const grouped = ipEntries.reduce((acc, { entry, country }) => {
      if (!acc[country]) {
        acc[country] = [];
      }
      if (shu === 0 || acc[country].length < shu) {
        acc[country].push(entry);
      }
      return acc;
    }, {});
    console.log("IP å’Œç«¯å£æ ¹æ®å›½å®¶åˆ†ç»„å®Œæˆã€‚");

    // å¯é€‰ï¼šå¯¹å›½å®¶è¿›è¡Œæ’åºåæ‹¼æ¥æ‰€æœ‰åˆ†ç»„
    const result = Object.keys(grouped)
      .sort() // å¯¹å›½å®¶åç§°è¿›è¡Œæ’åº
      .map((country, index) => {
        return grouped[country]
          .map((entry, index) => `${entry}${index + 1}`) // æ·»åŠ åºå·
          .join("\n");
      })
      .join("\n");
    const countries = Object.keys(grouped).sort().join("ã€");
    console.log(`æå–å›½å®¶: ${countries}`);
    await fs.promises.writeFile(txtFilePath, result, "utf8");
    console.log(`å·²æˆåŠŸæå–åˆ° ${txtFilePath}`);
  } catch (error) {
    console.error("å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯:", error.message);
  }
}
async function getDatacenterMap() {
  console.log("å¼€å§‹è·å– Cloudflare æ•°æ®ä¸­å¿ƒä½ç½®...");

  try {
    const response = await fetch("https://speed.cloudflare.com/locations");
    const data = await response.json();

    console.log("æˆåŠŸè·å– Cloudflare æ•°æ®ä¸­å¿ƒæ•°æ®ï¼Œå¼€å§‹å¤„ç†æ•°æ®...");

    const datacenterMap = {};

    data.forEach(({ iata, cca2 }) => {
      if (!datacenterMap[cca2]) {
        datacenterMap[cca2] = [];
      }
      datacenterMap[cca2].push(iata);
    });

    console.log("æ•°æ®ä¸­å¿ƒæ˜ å°„åˆ›å»ºæˆåŠŸã€‚");
    console.log("å¼€å§‹ä¿®æ”¹æ•°æ®ä¸­å¿ƒæ˜ å°„...");
    const newDatacenterMap = await modifyDatacenterMap(
      extractedData,
      datacenterMap,
    );

    console.log("æ•°æ®ä¸­å¿ƒæ˜ å°„ä¿®æ”¹å®Œæˆ");
    return newDatacenterMap;
  } catch (error) {
    console.error("è·å–æ•°æ®ä¸­å¿ƒæ˜ å°„å¤±è´¥:", error);
  }
}
async function modifyDatacenterMap(extractedData, datacenterMap) {
  console.log("å¼€å§‹ä¿®æ”¹æ•°æ®ä¸­å¿ƒæ˜ å°„çš„é”®...");

  try {
    // ç”Ÿæˆæ–°çš„ datacenterMap
    let newDatacenterMap = {};

    Object.entries(datacenterMap).forEach(([isoCode, values]) => {
      const newKey = extractedData[isoCode] || isoCode; // æ‰¾åˆ°æ”¿æ²»å®ä½“åç§°ï¼Œæ‰¾ä¸åˆ°å°±ç”¨åŸé”®
      newDatacenterMap[newKey] = values; // ä¿æŒå€¼ä¸å˜
    });

    console.log("æ•°æ®ä¸­å¿ƒæ˜ å°„é”®ä¿®æ”¹å®Œæˆã€‚");
    return newDatacenterMap;
  } catch (error) {
    console.error("ä¿®æ”¹ datacenterMap å¤±è´¥:", error);
  }
}
await processCSVFiles();
